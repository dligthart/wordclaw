<svg xmlns="http://www.w3.org/2000/svg" width="980" height="1220" viewBox="0 0 980 1220">
  <defs>
    <style>
      .title { font: 700 26px Arial, sans-serif; fill: #0f172a; }
      .step { fill: #ffffff; stroke: #1e293b; stroke-width: 2; rx: 10; ry: 10; }
      .label { font: 600 16px Arial, sans-serif; fill: #0f172a; }
      .small { font: 500 13px Arial, sans-serif; fill: #334155; }
      .error { fill: #fff1f2; stroke: #be123c; stroke-width: 2; rx: 8; ry: 8; }
      .arrow { stroke: #334155; stroke-width: 2.5; fill: none; marker-end: url(#arrow); }
      .branch { stroke: #be123c; stroke-width: 2; fill: none; stroke-dasharray: 7 5; marker-end: url(#arrowRed); }
    </style>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#334155" />
    </marker>
    <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#be123c" />
    </marker>
  </defs>

  <text class="title" x="40" y="42">Request Lifecycle</text>

  <rect class="step" x="290" y="80" width="400" height="60" />
  <text class="label" x="425" y="116">Client Request</text>

  <rect class="step" x="290" y="180" width="400" height="60" />
  <text class="label" x="385" y="216">Assign x-request-id</text>

  <rect class="step" x="290" y="280" width="400" height="60" />
  <text class="label" x="385" y="316">Rate Limit Check</text>

  <rect class="error" x="740" y="280" width="190" height="60" />
  <text class="label" x="782" y="316">429 Response</text>

  <rect class="step" x="290" y="380" width="400" height="60" />
  <text class="label" x="355" y="416">Idempotency Lookup</text>

  <rect class="error" x="740" y="380" width="190" height="60" />
  <text class="label" x="772" y="404">Replay / 409</text>
  <text class="small" x="775" y="424">duplicate in-flight</text>

  <rect class="step" x="290" y="480" width="400" height="60" />
  <text class="label" x="430" y="516">Authenticate</text>

  <rect class="error" x="740" y="480" width="190" height="60" />
  <text class="label" x="775" y="505">401 / 403</text>
  <text class="small" x="772" y="525">missing or bad scope</text>

  <rect class="step" x="290" y="580" width="400" height="60" />
  <text class="label" x="330" y="616">Route Handler (REST / GraphQL / MCP)</text>

  <rect class="step" x="290" y="680" width="400" height="60" />
  <text class="label" x="335" y="716">Service Layer (validate + execute)</text>

  <rect class="step" x="290" y="780" width="400" height="80" />
  <text class="label" x="372" y="816">Side Effects</text>
  <text class="small" x="338" y="838">Audit log write, event bus emit, webhook delivery</text>

  <rect class="step" x="290" y="900" width="400" height="60" />
  <text class="label" x="336" y="936">Cache idempotent response (writes)</text>

  <rect class="step" x="290" y="1000" width="400" height="80" />
  <text class="label" x="350" y="1036">Return Response</text>
  <text class="small" x="410" y="1058">with x-request-id</text>

  <line class="arrow" x1="490" y1="140" x2="490" y2="180" />
  <line class="arrow" x1="490" y1="240" x2="490" y2="280" />
  <line class="arrow" x1="490" y1="340" x2="490" y2="380" />
  <line class="arrow" x1="490" y1="440" x2="490" y2="480" />
  <line class="arrow" x1="490" y1="540" x2="490" y2="580" />
  <line class="arrow" x1="490" y1="640" x2="490" y2="680" />
  <line class="arrow" x1="490" y1="740" x2="490" y2="780" />
  <line class="arrow" x1="490" y1="860" x2="490" y2="900" />
  <line class="arrow" x1="490" y1="960" x2="490" y2="1000" />

  <path class="branch" d="M690 310 L740 310" />
  <path class="branch" d="M690 410 L740 410" />
  <path class="branch" d="M690 510 L740 510" />
</svg>
